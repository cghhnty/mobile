var stylus = require('stylus');
var nib = require('nib');
var path = require('path');
var imgHash = require('./styl.imgHash');

module.exports = function(files, opts, cb) {
	var style = stylus('')
		.include(path.dirname(opts.filename))
		.use(nib())
		.set('filename', path.basename(opts.filename))
		.set('include css', true)
		.set('compress', opts.compress)
		.set('sourcemap', {sourceRoot: opts.sourceRoot})
		.define('url', imgHash);

	files.map(function(file) {
		style.import(file);
	});

	style.render(function(err, css) {
		if (err)
			return cb(err);

		cb(null, {
			data: new Buffer(css),
			map: JSON.stringify(style.sourcemap)
		});
	});
};
