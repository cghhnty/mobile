var uglifyJs = require("uglify-js");
var path = require('path');

module.exports = function(files, opts, cb) {
	if (!opts.srcModified())
		return cb();

	try {
		var options = {
			outSourceMap: path.basename(opts.filename) + '.map',
			sourceRoot: opts.sourceRoot
		};

		if (!opts.compress) {
			options.mangle = false;
			options.compress = false;
			options.output = {
				beautify: true
			};
		}

		var result = uglifyJs.minify(files, options);

		cb(null, {
			data: new Buffer(result.code),
			map: result.map
		});
	} catch (e) {
		delete e.stack;
		return cb(e);
	}
};
