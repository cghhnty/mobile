var fs = require('fs');
var path = require('path');
var rimraf = require('rimraf');

module.exports = clean;

function clean(src, dest) {
	try {
		var files = fs.readdirSync(dest);
	} catch (e) {
		console.error(e);
		return false;
	}

	for (var i = 0; i < files.length; i++) {
		var filename = files[i];
		var fileDest = dest + '/' + filename;
		try {
			var stats = fs.statSync(fileDest);
		} catch (e) {
			continue;
		}

		if (stats.isDirectory()) {
			var fileSrc = src + '/' + filename;
			if (fs.existsSync(fileSrc)) {
				if (!clean(fileSrc, fileDest))
					return;
			} else {
				console.log('clean: ' + fileDest);
				rimraf.sync(fileDest);
			}
		} else {
			var extname = path.extname(filename).slice(1);
			if (extname in {map: 1, gz: 1, meta: 1, noclean: 1})
				continue;

			if (fs.existsSync(fileDest + '.noclean'))
				continue;

			var meta = JSON.parse(fs.readFileSync(fileDest + '.meta'));
			if (!fs.existsSync(meta.source)) {
				console.log('clean: ' + fileDest);
				try {fs.unlinkSync(fileDest + '.map')} catch (e) {}
				try {fs.unlinkSync(fileDest + '.gz')} catch (e) {}
				try {fs.unlinkSync(fileDest + '.meta')} catch (e) {}
				try {fs.unlinkSync(fileDest)} catch (e) {}
			}
		}
	}

	return true;
}
