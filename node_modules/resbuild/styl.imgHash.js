var stylus = require('stylus');
var url = require('url');
var fs = require('fs');
var crypto = require('crypto');

module.exports = function(_url) {
	// compile the url
	var compiler = new stylus.Compiler(_url);
	compiler.isURL = true;

	_url = _url.nodes.map(function(node) {
		return compiler.visit(node);
	}).join('');

	_url = url.parse(_url);

	var literal = new stylus.nodes.Literal('url("' + _url.href + '")');

	// absolute
	if (url.protocol)
		return literal;

	// lookup
	var found = stylus.utils.lookup(_url.pathname, this.paths);

	if (!found)
		return literal;

	var buf = fs.readFileSync(found);
	var hash = crypto.createHash('md5').update(buf).digest('hex');

	if (_url.search) {
		_url.search += '&v=' + hash;
	} else {
		_url.search = '?v=' + hash;
	}

	_url = url.format(_url);
	return new stylus.nodes.Literal('url("' + _url + '")');
}

module.exports.raw = true;
