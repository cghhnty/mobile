var fs = require('fs');
var compile = require('./compile');
var clean = require('./clean');
var makeChecksums = require('./makeChecksums');

module.exports = function(src, dest, opts, cb) {
	if (!cb)
		cb = function() {};

	var building = true;
	build(function(err) {
		if (!opts.watch)
			return cb();

		console.log('watching...');
		fs.watch(src, function(e) {
			if (building)
				return;

			building = true;
			setTimeout(function() {
				build(cb);
			}, 100);
		});
	});

	function build(cb) {
		console.log('building...');
		var start = Date.now();
		compile(src, dest, opts.compileOpts, function(err) {
			if (err)
				return cb(err);

			clean(src, dest);
			if (opts.makeChecksumsConf)
				makeChecksums(opts.makeChecksumsConf, opts.makeChecksumsOpts);
			building = false;
			console.log('time: ' + (Date.now() - start) / 1000 + ' seconds');
			cb();
		});
	}
};
